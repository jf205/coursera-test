
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Analyzing data flow and tracking tainted data in Python &#8212; Learn CodeQL</title>
    <link rel="stylesheet" href="../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '1.25',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="CodeQL training and variant analysis examples" href="../ql-training.html" />
    <link rel="prev" title="Analyzing control flow in Python" href="control-flow.html" />

<title>CodeQL docs</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="stylesheet" href="../_static/custom.css" type="text/css" />
<link rel="stylesheet" href="../_static/primer.css" type="text/css" />


  </head>
  <body>
<header class="Header">
    <div class="Header-item--full">
        <a href="../index.html" class="Header-link f2 d-flex flex-items-center">
            <!-- <%= octicon "mark-github", class: "mr-2", height: 32 %> -->
            <svg height="32" class="octicon octicon-mark-github mr-2" viewBox="0 0 16 16" version="1.1" width="32"
                aria-hidden="true">
                <path fill-rule="evenodd"
                    d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0 0 16 8c0-4.42-3.58-8-8-8z">
                </path>
            </svg>
            <span class="hide-sm">Learning CodeQL</span>
        </a>
    </div>
    <div class="Header-item hide-sm hide-md">
        <form class="search" action="../search.html" method="get">
            <input class="form-control input-dark" type="text" name="q" placeholder="Search" />
            <input class="btn" type="submit" value="Search" />
            <input type="hidden" name="check_keywords" value="yes" />
            <input type="hidden" name="area" value="default" />
        </form>
        <script type="text/javascript">$('#searchbox').show(0);</script>

        <div class="clearer"></div>
    </div>
    <div class="Header-item">

        <details class="dropdown details-reset details-overlay d-inline-block">
            <summary class="btn bg-gray-dark text-white border" aria-haspopup="true">
                CodeQL resources
                <div class="dropdown-caret"></div>
            </summary>

            <ul class="dropdown-menu dropdown-menu-se dropdown-menu-dark">
                <div class="dropdown-header">
                    Help docs
                </div>
                <li><a class="dropdown-item" href="https://help.semmle.com/QL/learn-ql/">Learn CodeQL</a></li>
                <li><a class="dropdown-item" href="https://help.semmle.com/codeql/codeql-tools.html">CodeQL tools</a>
                </li>
                <li class="dropdown-divider" role="separator"></li>
                <div class="dropdown-header">
                    Reference docs
                </div>
                <li><a class="dropdown-item" href="https://help.semmle.com/QL/ql-handbook/">QL language reference</a>
                <li><a class="dropdown-item" href="https://help.semmle.com/QL/ql-libraries.html">CodeQL libraries</a>
                <li><a class="dropdown-item" href="https://help.semmle.com/QL/ql-built-in-queries.html">CodeQL
                        queries</a>
                <li class="dropdown-divider" role="separator"></li>
                <div class="dropdown-header">
                    Source files
                </div>
                <li><a class="dropdown-item" href="https://github.com/github/codeql">CodeQL repository</a>
            </ul>
        </details>

    </div>

</header>
<main class="bg-gray-light clearfix">
<nav class="SideNav position-sticky top-0 col-lg-3 col-md-3 float-left p-4 hide-sm hide-md overflow-y-auto">

    <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../beginner/ql-tutorials.html">QL tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../writing-queries/writing-queries.html">CodeQL queries</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cpp/ql-for-cpp.html">CodeQL for C and C++</a></li>
<li class="toctree-l1"><a class="reference internal" href="../csharp/ql-for-csharp.html">CodeQL for C#</a></li>
<li class="toctree-l1"><a class="reference internal" href="../go/ql-for-go.html">CodeQL for Go</a></li>
<li class="toctree-l1"><a class="reference internal" href="../java/ql-for-java.html">CodeQL for Java</a></li>
<li class="toctree-l1"><a class="reference internal" href="../javascript/ql-for-javascript.html">CodeQL for JavaScript</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="ql-for-python.html">CodeQL for Python</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="basic-query-python.html">Basic query for Python code</a></li>
<li class="toctree-l2"><a class="reference internal" href="introduce-libraries-python.html">CodeQL library for Python</a></li>
<li class="toctree-l2"><a class="reference internal" href="functions.html">Functions in Python</a></li>
<li class="toctree-l2"><a class="reference internal" href="statements-expressions.html">Expressions and statements in Python</a></li>
<li class="toctree-l2"><a class="reference internal" href="pointsto-type-infer.html">Pointer analysis and type inference in Python</a></li>
<li class="toctree-l2"><a class="reference internal" href="control-flow.html">Analyzing control flow in Python</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Analyzing data flow and tracking tainted data in Python</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../ql-training.html">CodeQL training and variant analysis examples</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../terminology-note.html">Recent terminology changes</a></li>
</ul>


</nav>


<div class="body col-sm-12 col-md-9 col-lg-9 float-left border-left">

    <div class="hide-lg hide-xl px-4 pt-4">
        
<div class="related" role="navigation" aria-label="related navigation">
    <ul>
        <li class="nav-item nav-item-0"><a href="../index.html">Learn CodeQL</a> &#187;</li>
        <li class="nav-item nav-item-1"><a href="ql-for-python.html"
                accesskey="U">CodeQL for Python</a> &#187;</li> 
    </ul>
</div>
    </div>

    <article class="p-4 col-lg-10 col-md-10 col-sm-12">
        
  <div class="section" id="analyzing-data-flow-and-tracking-tainted-data-in-python">
<h1>Analyzing data flow and tracking tainted data in Python<a class="headerlink" href="#analyzing-data-flow-and-tracking-tainted-data-in-python" title="Permalink to this headline">¶</a></h1>
<p>You can use CodeQL to track the flow of data through a Python program. Tracking user-controlled, or tainted, data is a key technique for security researchers.</p>
<div class="section" id="about-data-flow-and-taint-tracking">
<h2>About data flow and taint tracking<a class="headerlink" href="#about-data-flow-and-taint-tracking" title="Permalink to this headline">¶</a></h2>
<p>Taint tracking is used to analyze how potentially insecure, or ‘tainted’ data flows throughout a program at runtime.
You can use taint tracking to find out whether user-controlled input can be used in a malicious way,
whether dangerous arguments are passed to vulnerable functions, and whether confidential or sensitive data can leak.
You can also use it to track invalid, insecure, or untrusted data in other analyses.</p>
<p>Taint tracking differs from basic data flow in that it considers non-value-preserving steps in addition to ‘normal’ data flow steps.
For example, in the assignment <code class="docutils literal"><span class="pre">dir</span> <span class="pre">=</span> <span class="pre">path</span> <span class="pre">+</span> <span class="pre">&quot;/&quot;</span></code>, if <code class="docutils literal"><span class="pre">path</span></code> is tainted then <code class="docutils literal"><span class="pre">dir</span></code> is also tainted,
even though there is no data flow from <code class="docutils literal"><span class="pre">path</span></code> to <code class="docutils literal"><span class="pre">path</span> <span class="pre">+</span> <span class="pre">&quot;/&quot;</span></code>.</p>
<p>Separate CodeQL libraries have been written to handle ‘normal’ data flow and taint tracking in <a class="reference internal" href="../cpp/dataflow.html"><span class="doc">C/C++</span></a>, <a class="reference internal" href="../csharp/dataflow.html"><span class="doc">C#</span></a>, <a class="reference internal" href="../java/dataflow.html"><span class="doc">Java</span></a>, and <a class="reference internal" href="../javascript/dataflow.html"><span class="doc">JavaScript</span></a>. You can access the appropriate classes and predicates that reason about these different modes of data flow by importing the appropriate library in your query.
In Python analysis, we can use the same taint tracking library to model both ‘normal’ data flow and taint flow, but we are still able make the distinction between steps that preserve values and those that don’t by defining additional data flow properties.</p>
<p>For further information on data flow and taint tracking with CodeQL, see “<a class="reference internal" href="../intro-to-data-flow.html"><span class="doc">Introduction to data flow</span></a>.”</p>
<div class="section" id="fundamentals-of-taint-tracking-using-data-flow-analysis">
<h3>Fundamentals of taint tracking using data flow analysis<a class="headerlink" href="#fundamentals-of-taint-tracking-using-data-flow-analysis" title="Permalink to this headline">¶</a></h3>
<p>The taint tracking library is in the <a class="reference external" href="https://help.semmle.com/qldoc/python/semmle/python/dataflow/TaintTracking.qll/module.TaintTracking.html">TaintTracking</a> module.
Any taint tracking or data flow analysis query has three explicit components, one of which is optional, and an implicit component.
The explicit components are:</p>
<ol class="arabic simple">
<li>One or more <code class="docutils literal"><span class="pre">sources</span></code> of potentially insecure or unsafe data, represented by the <a class="reference external" href="https://help.semmle.com/qldoc/python/semmle/python/dataflow/TaintTracking.qll/type.TaintTracking$TaintSource.html">TaintTracking::Source</a> class.</li>
<li>One or more <code class="docutils literal"><span class="pre">sinks</span></code>, to where the data or taint may flow, represented by the <a class="reference external" href="https://help.semmle.com/qldoc/python/semmle/python/dataflow/TaintTracking.qll/type.TaintTracking$TaintSink.html">TaintTracking::Sink</a> class.</li>
<li>Zero or more <code class="docutils literal"><span class="pre">sanitizers</span></code>, represented by the <a class="reference external" href="https://help.semmle.com/qldoc/python/semmle/python/dataflow/TaintTracking.qll/type.TaintTracking$Sanitizer.html">Sanitizer</a> class.</li>
</ol>
<p>A taint tracking or data flow query gives results when there is the flow of data from a source to a sink, which is not blocked by a sanitizer.</p>
<p>These three components are bound together using a <a class="reference external" href="https://help.semmle.com/qldoc/python/semmle/python/dataflow/Configuration.qll/type.Configuration$TaintTracking$Configuration.html">TaintTracking::Configuration</a>.
The purpose of the configuration is to specify exactly which sources and sinks are relevant to the specific query.</p>
<p>The final, implicit component is the “kind” of taint, represented by the <a class="reference external" href="https://help.semmle.com/qldoc/python/semmle/python/dataflow/TaintTracking.qll/type.TaintTracking$TaintKind.html">TaintKind</a> class.
The kind of taint determines which non-value-preserving steps are possible, in addition to value-preserving steps that are built into the analysis.
In the above example <code class="docutils literal"><span class="pre">dir</span> <span class="pre">=</span> <span class="pre">path</span> <span class="pre">+</span> <span class="pre">&quot;/&quot;</span></code>, taint flows from <code class="docutils literal"><span class="pre">path</span></code> to <code class="docutils literal"><span class="pre">dir</span></code> if the taint represents a string, but not if the taint is <code class="docutils literal"><span class="pre">None</span></code>.</p>
</div>
<div class="section" id="limitations">
<h3>Limitations<a class="headerlink" href="#limitations" title="Permalink to this headline">¶</a></h3>
<p>Although taint tracking is a powerful technique, it is worth noting that it depends on the underlying data flow graphs.
Creating a data flow graph that is both accurate and covers a large enough part of a program is a challenge,
especially for a dynamic language like Python. The call graph might be incomplete, the reachability of code is an approximation,
and certain constructs, like <code class="docutils literal"><span class="pre">eval</span></code>, are just too dynamic to analyze.</p>
</div>
</div>
<div class="section" id="using-taint-tracking-for-python">
<h2>Using taint-tracking for Python<a class="headerlink" href="#using-taint-tracking-for-python" title="Permalink to this headline">¶</a></h2>
<p>A simple taint tracking query has the basic form:</p>
<div class="highlight-ql"><div class="highlight"><pre><span></span><span class="cp">/**</span>
<span class="cp"> * @name ...</span>
<span class="cp"> * @description ...</span>
<span class="cp"> * @kind problem</span>
<span class="cp"> */</span>

<span class="k">import</span> <span class="n">semmle</span><span class="p">.</span><span class="n">python</span><span class="p">.</span><span class="n">security</span><span class="p">.</span><span class="n">TaintTracking</span>

<span class="k">class</span> <span class="n">MyConfiguration</span> <span class="k">extends</span> <span class="n">TaintTracking</span><span class="o">::</span><span class="n">Configuration</span> <span class="p">{</span>

    <span class="n">MyConfiguration</span><span class="p">()</span> <span class="p">{</span> <span class="k">this</span> <span class="o">=</span> <span class="s">&quot;My example configuration&quot;</span> <span class="p">}</span>

    <span class="kr">override </span><span class="k">predicate</span> <span class="n">isSource</span><span class="p">(</span><span class="n">TaintTracking</span><span class="o">::</span><span class="n">Source</span> <span class="n">src</span><span class="p">)</span> <span class="p">{</span> <span class="p">...</span> <span class="p">}</span>

    <span class="kr">override </span><span class="k">predicate</span> <span class="n">isSink</span><span class="p">(</span><span class="n">TaintTracking</span><span class="o">::</span><span class="n">Sink</span> <span class="n">sink</span><span class="p">)</span> <span class="p">{</span> <span class="p">...</span> <span class="p">}</span>

    <span class="cm">/* optionally */</span>
    <span class="kr">override </span><span class="k">predicate</span> <span class="n">isExtension</span><span class="p">(</span><span class="n">Extension</span> <span class="n">extension</span><span class="p">)</span> <span class="p">{</span> <span class="p">...</span> <span class="p">}</span>

<span class="p">}</span>

<span class="k">from</span> <span class="n">MyConfiguration</span> <span class="n">config</span><span class="p">,</span> <span class="n">TaintTracking</span><span class="o">::</span><span class="n">Source</span> <span class="n">src</span><span class="p">,</span> <span class="n">TaintTracking</span><span class="o">::</span><span class="n">Sink</span> <span class="n">sink</span>
<span class="k">where</span> <span class="n">config</span><span class="p">.</span><span class="n">hasFlow</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">sink</span><span class="p">)</span>
<span class="k">select</span> <span class="n">sink</span><span class="p">,</span> <span class="s">&quot;Alert message, including reference to $@.&quot;</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="s">&quot;string describing the source&quot;</span>
</pre></div>
</div>
<div class="section" id="example">
<h3>Example<a class="headerlink" href="#example" title="Permalink to this headline">¶</a></h3>
<p>As a contrived example, here is a query that looks for flow from a HTTP request to a function called <code class="docutils literal"><span class="pre">&quot;unsafe&quot;</span></code>.
The sources are predefined and accessed by importing library <code class="docutils literal"><span class="pre">semmle.python.web.HttpRequest</span></code>.
The sink is defined by using a custom <code class="docutils literal"><span class="pre">TaintTracking::Sink</span></code> class.</p>
<div class="highlight-ql"><div class="highlight"><pre><span></span><span class="cm">/* Import the string taint kind needed by our custom sink */</span>
<span class="k">import</span> <span class="n">semmle</span><span class="p">.</span><span class="n">python</span><span class="p">.</span><span class="n">security</span><span class="p">.</span><span class="n">strings</span><span class="p">.</span><span class="n">Untrusted</span>

<span class="cm">/* Sources */</span>
<span class="k">import</span> <span class="n">semmle</span><span class="p">.</span><span class="n">python</span><span class="p">.</span><span class="n">web</span><span class="p">.</span><span class="n">HttpRequest</span>

<span class="cm">/* Sink */</span>
<span class="cp">/** A class representing any argument in a call to a function called &quot;unsafe&quot; */</span>
<span class="k">class</span> <span class="n">UnsafeSink</span> <span class="k">extends</span> <span class="n">TaintTracking</span><span class="o">::</span><span class="n">Sink</span> <span class="p">{</span>

    <span class="n">UnsafeSink</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">exists</span><span class="p">(</span><span class="n">FunctionValue</span> <span class="n">unsafe</span> <span class="o">|</span>
            <span class="n">unsafe</span><span class="p">.</span><span class="n">getName</span><span class="p">()</span> <span class="o">=</span> <span class="s">&quot;unsafe&quot;</span> <span class="k">and</span>
            <span class="n">unsafe</span><span class="p">.</span><span class="n">getACall</span><span class="p">().(</span><span class="n">CallNode</span><span class="p">).</span><span class="n">getAnArg</span><span class="p">()</span> <span class="o">=</span> <span class="k">this</span>
        <span class="p">)</span>
    <span class="p">}</span>

    <span class="kr">override </span><span class="k">predicate</span> <span class="n">sinks</span><span class="p">(</span><span class="n">TaintKind</span> <span class="n">kind</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">kind</span> <span class="k">instanceof</span> <span class="n">StringKind</span>
    <span class="p">}</span>

<span class="p">}</span>

<span class="k">class</span> <span class="n">HttpToUnsafeConfiguration</span> <span class="k">extends</span> <span class="n">TaintTracking</span><span class="o">::</span><span class="n">Configuration</span> <span class="p">{</span>

    <span class="n">HttpToUnsafeConfiguration</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">this</span> <span class="o">=</span> <span class="s">&quot;Example config finding flow from http request to &#39;unsafe&#39; function&quot;</span>
    <span class="p">}</span>

    <span class="kr">override </span><span class="k">predicate</span> <span class="n">isSource</span><span class="p">(</span><span class="n">TaintTracking</span><span class="o">::</span><span class="n">Source</span> <span class="n">src</span><span class="p">)</span> <span class="p">{</span> <span class="n">src</span> <span class="k">instanceof</span> <span class="n">HttpRequestTaintSource</span> <span class="p">}</span>

    <span class="kr">override </span><span class="k">predicate</span> <span class="n">isSink</span><span class="p">(</span><span class="n">TaintTracking</span><span class="o">::</span><span class="n">Sink</span> <span class="n">sink</span><span class="p">)</span> <span class="p">{</span> <span class="n">sink</span> <span class="k">instanceof</span> <span class="n">UnsafeSink</span> <span class="p">}</span>

<span class="p">}</span>

<span class="k">from</span> <span class="n">HttpToUnsafeConfiguration</span> <span class="n">config</span><span class="p">,</span> <span class="n">TaintTracking</span><span class="o">::</span><span class="n">Source</span> <span class="n">src</span><span class="p">,</span> <span class="n">TaintTracking</span><span class="o">::</span><span class="n">Sink</span> <span class="n">sink</span>
<span class="k">where</span> <span class="n">config</span><span class="p">.</span><span class="n">hasFlow</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">sink</span><span class="p">)</span>
<span class="k">select</span> <span class="n">sink</span><span class="p">,</span> <span class="s">&quot;This argument to &#39;unsafe&#39; depends on $@.&quot;</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="s">&quot;a user-provided value&quot;</span>
</pre></div>
</div>
</div>
<div class="section" id="converting-a-taint-tracking-query-to-a-path-query">
<h3>Converting a taint-tracking query to a path query<a class="headerlink" href="#converting-a-taint-tracking-query-to-a-path-query" title="Permalink to this headline">¶</a></h3>
<p>Although the taint tracking query above tells which sources flow to which sinks, it doesn’t tell us how.
For that we need a path query.</p>
<p>A standard taint tracking query can be converted to a path query by changing <code class="docutils literal"><span class="pre">&#64;kind</span> <span class="pre">problem</span></code> to <code class="docutils literal"><span class="pre">&#64;kind</span> <span class="pre">path-problem</span></code>,
adding an import and changing the format of the query clauses.
The import is simply:</p>
<div class="highlight-ql"><div class="highlight"><pre><span></span><span class="k">import</span> <span class="n">semmle</span><span class="p">.</span><span class="n">python</span><span class="p">.</span><span class="n">security</span><span class="p">.</span><span class="n">Paths</span>
</pre></div>
</div>
<p>And the format of the query becomes:</p>
<div class="highlight-ql"><div class="highlight"><pre><span></span><span class="k">from</span> <span class="n">Configuration</span> <span class="n">config</span><span class="p">,</span> <span class="n">TaintedPathSource</span> <span class="n">src</span><span class="p">,</span> <span class="n">TaintedPathSink</span> <span class="n">sink</span>
<span class="k">where</span> <span class="n">config</span><span class="p">.</span><span class="n">hasFlowPath</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">sink</span><span class="p">)</span>
<span class="k">select</span> <span class="n">sink</span><span class="p">.</span><span class="n">getSink</span><span class="p">(),</span> <span class="n">src</span><span class="p">,</span> <span class="n">sink</span><span class="p">,</span> <span class="s">&quot;Alert message, including reference to $@.&quot;</span><span class="p">,</span> <span class="n">src</span><span class="p">.</span><span class="n">getSource</span><span class="p">(),</span> <span class="s">&quot;string describing the source&quot;</span>
</pre></div>
</div>
<p>Thus, our example query becomes:</p>
<div class="highlight-ql"><div class="highlight"><pre><span></span><span class="cp">/**</span>
<span class="cp"> * ...</span>
<span class="cp"> * @kind path-problem</span>
<span class="cp"> * ...</span>
<span class="cp"> */</span>

<span class="cm">/* This computes the paths */</span>
<span class="k">import</span> <span class="n">semmle</span><span class="p">.</span><span class="n">python</span><span class="p">.</span><span class="n">security</span><span class="p">.</span><span class="n">Paths</span>

<span class="cm">/* Expose the string taint kinds needed by our custom sink */</span>
<span class="k">import</span> <span class="n">semmle</span><span class="p">.</span><span class="n">python</span><span class="p">.</span><span class="n">security</span><span class="p">.</span><span class="n">strings</span><span class="p">.</span><span class="n">Untrusted</span>

<span class="cm">/* Sources */</span>
<span class="k">import</span> <span class="n">semmle</span><span class="p">.</span><span class="n">python</span><span class="p">.</span><span class="n">web</span><span class="p">.</span><span class="n">HttpRequest</span>

<span class="cm">/* Sink */</span>
<span class="cp">/** A class representing any argument in a call to a function called &quot;unsafe&quot; */</span>
<span class="k">class</span> <span class="n">UnsafeSink</span> <span class="k">extends</span> <span class="n">TaintTracking</span><span class="o">::</span><span class="n">Sink</span> <span class="p">{</span>

    <span class="n">UnsafeSink</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">exists</span><span class="p">(</span><span class="n">FunctionValue</span> <span class="n">unsafe</span> <span class="o">|</span>
            <span class="n">unsafe</span><span class="p">.</span><span class="n">getName</span><span class="p">()</span> <span class="o">=</span> <span class="s">&quot;unsafe&quot;</span> <span class="k">and</span>
            <span class="n">unsafe</span><span class="p">.</span><span class="n">getACall</span><span class="p">().(</span><span class="n">CallNode</span><span class="p">).</span><span class="n">getAnArg</span><span class="p">()</span> <span class="o">=</span> <span class="k">this</span>
        <span class="p">)</span>
    <span class="p">}</span>

    <span class="kr">override </span><span class="k">predicate</span> <span class="n">sinks</span><span class="p">(</span><span class="n">TaintKind</span> <span class="n">kind</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">kind</span> <span class="k">instanceof</span> <span class="n">StringKind</span>
    <span class="p">}</span>

<span class="p">}</span>

<span class="k">class</span> <span class="n">HttpToUnsafeConfiguration</span> <span class="k">extends</span> <span class="n">TaintTracking</span><span class="o">::</span><span class="n">Configuration</span> <span class="p">{</span>

    <span class="n">HttpToUnsafeConfiguration</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">this</span> <span class="o">=</span> <span class="s">&quot;Example config finding flow from http request to &#39;unsafe&#39; function&quot;</span>
    <span class="p">}</span>

    <span class="kr">override </span><span class="k">predicate</span> <span class="n">isSource</span><span class="p">(</span><span class="n">TaintTracking</span><span class="o">::</span><span class="n">Source</span> <span class="n">src</span><span class="p">)</span> <span class="p">{</span> <span class="n">src</span> <span class="k">instanceof</span> <span class="n">HttpRequestTaintSource</span> <span class="p">}</span>

    <span class="kr">override </span><span class="k">predicate</span> <span class="n">isSink</span><span class="p">(</span><span class="n">TaintTracking</span><span class="o">::</span><span class="n">Sink</span> <span class="n">sink</span><span class="p">)</span> <span class="p">{</span> <span class="n">sink</span> <span class="k">instanceof</span> <span class="n">UnsafeSink</span> <span class="p">}</span>

<span class="p">}</span>

<span class="k">from</span> <span class="n">HttpToUnsafeConfiguration</span> <span class="n">config</span><span class="p">,</span> <span class="n">TaintedPathSource</span> <span class="n">src</span><span class="p">,</span> <span class="n">TaintedPathSink</span> <span class="n">sink</span>
<span class="k">where</span> <span class="n">config</span><span class="p">.</span><span class="n">hasFlowPath</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">sink</span><span class="p">)</span>
<span class="k">select</span> <span class="n">sink</span><span class="p">.</span><span class="n">getSink</span><span class="p">(),</span> <span class="n">src</span><span class="p">,</span> <span class="n">sink</span><span class="p">,</span> <span class="s">&quot;This argument to &#39;unsafe&#39; depends on $@.&quot;</span><span class="p">,</span> <span class="n">src</span><span class="p">.</span><span class="n">getSource</span><span class="p">(),</span> <span class="s">&quot;a user-provided value&quot;</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="tracking-custom-taint-kinds-and-flows">
<h2>Tracking custom taint kinds and flows<a class="headerlink" href="#tracking-custom-taint-kinds-and-flows" title="Permalink to this headline">¶</a></h2>
<p>In the above examples, we have assumed the existence of a suitable <code class="docutils literal"><span class="pre">TaintKind</span></code>,
but sometimes it is necessary to model the flow of other objects, such as database connections, or <code class="docutils literal"><span class="pre">None</span></code>.</p>
<p>The <code class="docutils literal"><span class="pre">TaintTracking::Source</span></code> and <code class="docutils literal"><span class="pre">TaintTracking::Sink</span></code> classes have predicates that determine which kind of taint the source and sink model, respectively.</p>
<div class="highlight-ql"><div class="highlight"><pre><span></span><span class="kr">abstract </span><span class="k">class</span> <span class="n">Source</span> <span class="p">{</span>
    <span class="kr">abstract </span><span class="k">predicate</span> <span class="n">isSourceOf</span><span class="p">(</span><span class="n">TaintKind</span> <span class="n">kind</span><span class="p">);</span>
    <span class="p">...</span>
<span class="p">}</span>

<span class="kr">abstract </span><span class="k">class</span> <span class="n">Sink</span> <span class="p">{</span>
    <span class="kr">abstract </span><span class="k">predicate</span> <span class="n">sinks</span><span class="p">(</span><span class="n">TaintKind</span> <span class="n">taint</span><span class="p">);</span>
    <span class="p">...</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The <code class="docutils literal"><span class="pre">TaintKind</span></code> itself is just a string (a QL string, not a CodeQL entity representing a Python string),
which provides methods to extend flow and allow the kind of taint to change along the path.
The <code class="docutils literal"><span class="pre">TaintKind</span></code> class has many predicates allowing flow to be modified.
This simplest <code class="docutils literal"><span class="pre">TaintKind</span></code> does not override any predicates, meaning that it only flows as opaque data.
An example of this is the “Hard-coded credentials” query,
which defines the simplest possible taint kind class, <code class="docutils literal"><span class="pre">HardcodedValue</span></code>, and custom source and sink classes. For more information, see <a class="reference external" href="https://lgtm.com/query/rule:1506421276400/lang:python/">Hard-coded credentials</a> on LGTM.com.</p>
<div class="highlight-ql"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="n">HardcodedValue</span> <span class="k">extends</span> <span class="n">TaintKind</span> <span class="p">{</span>
    <span class="n">HardcodedValue</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">this</span> <span class="o">=</span> <span class="s">&quot;hard coded value&quot;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">class</span> <span class="n">HardcodedValueSource</span> <span class="k">extends</span> <span class="n">TaintTracking</span><span class="o">::</span><span class="n">Source</span> <span class="p">{</span>
    <span class="p">...</span>
    <span class="kr">override </span><span class="k">predicate</span> <span class="n">isSourceOf</span><span class="p">(</span><span class="n">TaintKind</span> <span class="n">kind</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">kind</span> <span class="k">instanceof</span> <span class="n">HardcodedValue</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">class</span> <span class="n">CredentialSink</span> <span class="k">extends</span> <span class="n">TaintTracking</span><span class="o">::</span><span class="n">Sink</span> <span class="p">{</span>
    <span class="p">...</span>
    <span class="kr">override </span><span class="k">predicate</span> <span class="n">sinks</span><span class="p">(</span><span class="n">TaintKind</span> <span class="n">kind</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">kind</span> <span class="k">instanceof</span> <span class="n">HardcodedValue</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="further-reading">
<h2>Further reading<a class="headerlink" href="#further-reading" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>“<a class="reference external" href="https://help.semmle.com/codeql/codeql-for-vscode/procedures/exploring-paths.html">Exploring data flow with path queries</a>”</li>
</ul>
<ul class="simple">
<li><a class="reference external" href="https://github.com/github/codeql/tree/main/python/ql/src">CodeQL queries for Python</a></li>
<li><a class="reference external" href="https://github.com/github/codeql/tree/main/python/ql/examples">Example queries for Python</a></li>
<li><a class="reference external" href="https://help.semmle.com/qldoc/python/">CodeQL library reference for Python</a></li>
</ul>
<ul class="simple">
<li>“<a class="reference external" href="https://help.semmle.com/QL/ql-handbook">QL language reference</a>”</li>
<li>“<a class="reference external" href="https://help.semmle.com/codeql/codeql-tools.html">CodeQL tools</a>”</li>
</ul>
</div>
</div>


    </article>

    <!-- GitHub footer, with links to terms and privacy statement -->
    <div class="px-3 px-md-6 f6 py-4 d-sm-flex flex-justify-between flex-row-reverse flex-items-center border-top">
        <ul class="list-style-none d-flex flex-items-center mb-3 mb-sm-0 lh-condensed-ultra">
            <li class="mr-3">
                <a href="https://twitter.com/github" title="GitHub on Twitter" style="color: #959da5;">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 273.5 222.3" class="d-block" height="18">
                        <path
                            d="M273.5 26.3a109.77 109.77 0 0 1-32.2 8.8 56.07 56.07 0 0 0 24.7-31 113.39 113.39 0 0 1-35.7 13.6 56.1 56.1 0 0 0-97 38.4 54 54 0 0 0 1.5 12.8A159.68 159.68 0 0 1 19.1 10.3a56.12 56.12 0 0 0 17.4 74.9 56.06 56.06 0 0 1-25.4-7v.7a56.11 56.11 0 0 0 45 55 55.65 55.65 0 0 1-14.8 2 62.39 62.39 0 0 1-10.6-1 56.24 56.24 0 0 0 52.4 39 112.87 112.87 0 0 1-69.7 24 119 119 0 0 1-13.4-.8 158.83 158.83 0 0 0 86 25.2c103.2 0 159.6-85.5 159.6-159.6 0-2.4-.1-4.9-.2-7.3a114.25 114.25 0 0 0 28.1-29.1"
                            fill="currentColor"></path>
                    </svg>
                </a>
            </li>
            <li class="mr-3">
                <a href="https://www.facebook.com/GitHub" title="GitHub on Facebook" style="color: #959da5;">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 15.3 15.4" class="d-block" height="18">
                        <path
                            d="M14.5 0H.8a.88.88 0 0 0-.8.9v13.6a.88.88 0 0 0 .8.9h7.3v-6h-2V7.1h2V5.4a2.87 2.87 0 0 1 2.5-3.1h.5a10.87 10.87 0 0 1 1.8.1v2.1h-1.3c-1 0-1.1.5-1.1 1.1v1.5h2.3l-.3 2.3h-2v5.9h3.9a.88.88 0 0 0 .9-.8V.8a.86.86 0 0 0-.8-.8z"
                            fill="currentColor"></path>
                    </svg>
                </a>
            </li>
            <li class="mr-3">
                <a href="https://www.youtube.com/github" title="GitHub on YouTube" style="color: #959da5;">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 19.17 13.6" class="d-block" height="16">
                        <path
                            d="M18.77 2.13A2.4 2.4 0 0 0 17.09.42C15.59 0 9.58 0 9.58 0a57.55 57.55 0 0 0-7.5.4A2.49 2.49 0 0 0 .39 2.13 26.27 26.27 0 0 0 0 6.8a26.15 26.15 0 0 0 .39 4.67 2.43 2.43 0 0 0 1.69 1.71c1.52.42 7.5.42 7.5.42a57.69 57.69 0 0 0 7.51-.4 2.4 2.4 0 0 0 1.68-1.71 25.63 25.63 0 0 0 .4-4.67 24 24 0 0 0-.4-4.69zM7.67 9.71V3.89l5 2.91z"
                            fill="currentColor"></path>
                    </svg>
                </a>
            </li>
            <li class="mr-3 flex-self-start">
                <a href="https://www.linkedin.com/company/github" title="GitHub on Linkedin" style="color: #959da5;">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 19 18" class="d-block" height="18">
                        <path
                            d="M3.94 2A2 2 0 1 1 2 0a2 2 0 0 1 1.94 2zM4 5.48H0V18h4zm6.32 0H6.34V18h3.94v-6.57c0-3.66 4.77-4 4.77 0V18H19v-7.93c0-6.17-7.06-5.94-8.72-2.91z"
                            fill="currentColor"></path>
                    </svg>
                </a>
            </li>
            <li>
                <a href="https://github.com/github" title="GitHub's organization" style="color: #959da5;">
                    <svg version="1.1" width="20" height="20" viewBox="0 0 16 16" class="octicon octicon-mark-github"
                        aria-hidden="true">
                        <path fill-rule="evenodd"
                            d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z">
                        </path>
                    </svg>
                </a>
            </li>
        </ul>
        <ul class="list-style-none d-flex text-gray">
            <li class="mr-3">&copy; 2020 GitHub, Inc.</li>
            <li class="mr-3"><a
                    href="https://docs.github.com/github/site-policy/github-terms-of-service"
                    class="link-gray">Terms </a></li>
            <li><a href="https://docs.github.com/github/site-policy/github-privacy-statement"
                    class="link-gray">Privacy </a></li>
        </ul>
    </div>
</div>
</main>

<script type="text/javascript">
    $(document).ready(function () {
        $(".toggle > *").hide();
        $(".toggle .name").show();
        $(".toggle .name").click(function () {
            $(this).parent().children().not(".name").toggle(400);
            $(this).parent().children(".name").toggleClass("open");
        })
    });
</script>

  </body>
</html>