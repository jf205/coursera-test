
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Using type tracking for API modeling &#8212; Learn CodeQL</title>
    <link rel="stylesheet" href="../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '1.25',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Abstract syntax tree classes for working with JavaScript and TypeScript programs" href="ast-class-reference.html" />
    <link rel="prev" title="Using flow labels for precise data flow analysis" href="flow-labels.html" />
  <!-- Google Tag Manager -->
  <script>(function(w,d,s,l,i) {w[l]=w[l]||[];w[l].push({'gtm.start':new Date().getTime(),event:'gtm.js'});var  f=d.getElementsByTagName(s)[0],j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true; j.src='https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);}) (window,document,'script','dataLayer','GTM-5Q9DBRM');</script>
  <!-- End Google Tag Manager -->
  
   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  </head>
  <body>
<!-- Google Tag Manager (noscript) -->
<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-5Q9DBRM" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
<!-- End Google Tag Manager (noscript) -->
<div id="siteBanner">
    <div class="logocontainer">
        <a href="https://securitylab.github.com" id="Header-logo" class="">
                <svg width="100%" height="100%" viewBox="0 0 696 160" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <rect width="696" height="160" fill="white"/>
                    <path fill-rule="evenodd" clip-rule="evenodd" d="M80.0397 32.8C53.4747 32.8 32 54.4342 32 81.1965C32 102.59 45.7597 120.699 64.8483 127.109C67.2344 127.59 68.1093 126.067 68.1093 124.785C68.1093 123.664 68.0297 119.818 68.0297 115.811C54.6677 118.696 51.884 110.042 51.884 110.042C49.7365 104.433 46.5551 102.991 46.5551 102.991C42.1806 100.026 46.8732 100.026 46.8732 100.026C51.7249 100.347 54.27 104.994 54.27 104.994C58.565 112.366 65.4846 110.283 68.2684 109C68.666 105.876 69.9386 103.712 71.2907 102.51C60.6329 101.388 49.4184 97.2219 49.4184 78.6325C49.4184 73.3441 51.3272 69.0173 54.3496 65.6519C53.8724 64.45 52.2021 59.4822 54.8268 52.8317C54.8268 52.8317 58.8831 51.5496 68.0297 57.7995C71.8475 56.7579 75.9833 56.197 80.0397 56.197C84.096 56.197 88.2319 56.7579 92.0496 57.7995C101.196 51.5496 105.253 52.8317 105.253 52.8317C107.877 59.4822 106.207 64.45 105.73 65.6519C108.832 69.0173 110.661 73.3441 110.661 78.6325C110.661 97.2219 99.4464 101.308 88.7091 102.51C90.4589 104.033 91.97 106.917 91.97 111.484C91.97 117.975 91.8905 123.183 91.8905 124.785C91.8905 126.067 92.7654 127.59 95.1515 127.109C114.24 120.699 128 102.59 128 81.1965C128.079 54.4342 106.525 32.8 80.0397 32.8Z" fill="black"/>
                    <path d="M50.2139 102.27C50.1343 102.51 49.7367 102.59 49.4185 102.43C49.1004 102.27 48.8618 101.949 49.0208 101.709C49.1004 101.469 49.4981 101.388 49.8162 101.549C50.1343 101.709 50.2934 102.029 50.2139 102.27Z" fill="black"/>
                    <path d="M52.1224 104.433C51.8837 104.674 51.4065 104.513 51.1679 104.193C50.8498 103.872 50.7702 103.392 51.0089 103.151C51.2475 102.911 51.6451 103.071 51.9633 103.392C52.2814 103.792 52.361 104.273 52.1224 104.433Z" fill="black"/>
                    <path d="M54.0314 107.238C53.7132 107.478 53.236 107.238 52.9974 106.837C52.6793 106.436 52.6793 105.876 52.9974 105.715C53.3155 105.475 53.7928 105.715 54.0314 106.116C54.3495 106.517 54.3495 106.997 54.0314 107.238Z" fill="black"/>
                    <path d="M56.656 109.962C56.4174 110.283 55.8607 110.202 55.3834 109.802C54.9858 109.401 54.8267 108.84 55.1448 108.6C55.3834 108.279 55.9402 108.359 56.4174 108.76C56.8151 109.081 56.8946 109.642 56.656 109.962Z" fill="black"/>
                    <path d="M60.2354 111.484C60.1558 111.885 59.5991 112.045 59.0423 111.885C58.4856 111.725 58.1674 111.244 58.247 110.924C58.3265 110.523 58.8832 110.363 59.44 110.523C59.9967 110.683 60.3149 111.084 60.2354 111.484Z" fill="black"/>
                    <path d="M64.1324 111.805C64.1324 112.206 63.6552 112.526 63.0984 112.526C62.5417 112.526 62.0645 112.206 62.0645 111.805C62.0645 111.404 62.5417 111.084 63.0984 111.084C63.6552 111.084 64.1324 111.404 64.1324 111.805Z" fill="black"/>
                    <path d="M67.791 111.164C67.8705 111.565 67.4729 111.965 66.9161 112.045C66.3594 112.125 65.8822 111.885 65.8026 111.484C65.7231 111.084 66.1208 110.683 66.6775 110.603C67.2343 110.523 67.7115 110.763 67.791 111.164Z" fill="black"/>
                    <path d="M190.125 70.1023H198.591C198.335 60.7841 190.097 54.0227 178.278 54.0227C166.602 54.0227 157.653 60.6989 157.653 70.7273C157.653 78.8239 163.449 83.5682 172.795 86.0966L179.67 87.9716C185.892 89.6193 190.693 91.6648 190.693 96.8352C190.693 102.517 185.267 106.267 177.795 106.267C171.034 106.267 165.409 103.256 164.898 96.9205H156.091C156.659 107.46 164.812 113.966 177.852 113.966C191.517 113.966 199.386 106.778 199.386 96.9205C199.386 86.4375 190.04 82.375 182.653 80.5568L176.972 79.0796C172.426 77.9148 166.375 75.7841 166.403 70.2159C166.403 65.2727 170.92 61.608 178.079 61.608C184.756 61.608 189.5 64.733 190.125 70.1023Z" fill="black"/>
                    <path d="M227.201 113.881C236.718 113.881 243.451 109.193 245.383 102.091L237.343 100.642C235.809 104.761 232.116 106.864 227.287 106.864C220.014 106.864 215.127 102.148 214.9 93.7386H245.923V90.7273C245.923 74.9602 236.491 68.7955 226.605 68.7955C214.446 68.7955 206.434 78.0568 206.434 91.4659C206.434 105.017 214.332 113.881 227.201 113.881ZM214.929 87.375C215.27 81.1818 219.758 75.8125 226.662 75.8125C233.252 75.8125 237.571 80.6989 237.599 87.375H214.929Z" fill="black"/>
                    <path d="M272.928 113.881C283.241 113.881 289.917 107.688 290.854 99.1932H282.587C281.508 103.909 277.843 106.693 272.985 106.693C265.798 106.693 261.167 100.699 261.167 91.1818C261.167 81.8352 265.883 75.9546 272.985 75.9546C278.383 75.9546 281.678 79.3636 282.587 83.4546H290.854C289.945 74.6477 282.758 68.7955 272.843 68.7955C260.542 68.7955 252.587 78.0568 252.587 91.3807C252.587 104.534 260.258 113.881 272.928 113.881Z" fill="black"/>
                    <path d="M326.78 94.9034C326.809 102.318 321.297 105.841 316.525 105.841C311.269 105.841 307.633 102.034 307.633 96.0966V69.3636H299.138V97.1193C299.138 107.943 305.076 113.568 313.456 113.568C320.019 113.568 324.479 110.102 326.496 105.443H326.951V113H335.303V69.3636H326.78V94.9034Z" fill="black"/>
                    <path d="M345.916 113H354.411V86.3523C354.411 80.6421 358.814 76.5227 364.837 76.5227C366.598 76.5227 368.587 76.8352 369.269 77.0341V68.9091C368.416 68.7955 366.74 68.7102 365.661 68.7102C360.547 68.7102 356.172 71.608 354.581 76.2955H354.127V69.3636H345.916V113Z" fill="black"/>
                    <path d="M375.82 113H384.314V69.3636H375.82V113ZM380.109 62.6307C383.035 62.6307 385.479 60.358 385.479 57.5739C385.479 54.7898 383.035 52.4886 380.109 52.4886C377.155 52.4886 374.74 54.7898 374.74 57.5739C374.74 60.358 377.155 62.6307 380.109 62.6307Z" fill="black"/>
                    <path d="M415.311 69.3636H406.362V58.9091H397.868V69.3636H391.475V76.1818H397.868V101.949C397.839 109.875 403.89 113.71 410.595 113.568C413.294 113.54 415.112 113.028 416.106 112.659L414.572 105.642C414.004 105.756 412.953 106.011 411.589 106.011C408.833 106.011 406.362 105.102 406.362 100.188V76.1818H415.311V69.3636Z" fill="black"/>
                    <path d="M429.276 129.25C436.293 129.25 440.754 125.585 443.254 118.824L461.293 69.4489L452.117 69.3636L441.066 103.227H440.612L429.56 69.3636H420.47L436.435 113.568L435.384 116.466C433.225 122.119 430.185 122.631 425.526 121.352L423.481 128.313C424.504 128.795 426.72 129.25 429.276 129.25Z" fill="black"/>
                    <path d="M489.551 113H524.693V105.443H498.33V54.8182H489.551V113Z" fill="black"/>
                    <path d="M545.925 113.966C553.141 113.966 557.203 110.301 558.822 107.034H559.163V113H567.459V84.0227C567.459 71.3239 557.459 68.7955 550.527 68.7955C542.629 68.7955 535.356 71.9773 532.516 79.9318L540.498 81.75C541.748 78.6534 544.93 75.6705 550.641 75.6705C556.123 75.6705 558.936 78.5398 558.936 83.483V83.6818C558.936 86.7784 555.754 86.7216 547.913 87.6307C539.646 88.5966 531.18 90.7557 531.18 100.67C531.18 109.25 537.629 113.966 545.925 113.966ZM547.771 107.148C542.97 107.148 539.504 104.989 539.504 100.784C539.504 96.2386 543.538 94.6193 548.453 93.9659C551.209 93.5966 557.743 92.858 558.964 91.6364V97.2614C558.964 102.432 554.845 107.148 547.771 107.148Z" fill="black"/>
                    <path d="M578.654 113H586.95V106.21H587.66C589.194 108.994 592.319 113.852 600.274 113.852C610.842 113.852 618.512 105.386 618.512 91.2671C618.512 77.1193 610.728 68.7955 600.189 68.7955C592.092 68.7955 589.166 73.7386 587.66 76.4375H587.149V54.8182H578.654V113ZM586.978 91.1818C586.978 82.0625 590.956 76.0114 598.37 76.0114C606.069 76.0114 609.933 82.5171 609.933 91.1818C609.933 99.9318 605.956 106.608 598.37 106.608C591.069 106.608 586.978 100.358 586.978 91.1818Z" fill="black"/>
                </svg>
                  
        </a>
    </div>            
        <div class="linkcontainer" id="linkcontainermenu">
                <div class="linkbar">
                    <a href="https://help.semmle.com/QL/learn-ql/">Learn CodeQL</a>
                    <a href="https://help.semmle.com/codeql/codeql-tools.html">CodeQL tools</a>
                    <a href="https://github.com/github/codeql">CodeQL repository</a>
                    <a href="https://help.semmle.com/QL/ql-libraries.html">CodeQL libraries</a>
                    <a href="javascript:void(0);" class="icon" onclick="myFunction()">
                        <i class="fa fa-bars"></i>
                      </a>
                </div>
       </div>
</div>  
<div id="title-banner">
    <a href="../index.html">Learning CodeQL</a>
    <div id="searchbox-title-banner" role="search">
            <form class="search" action="../search.html" method="get">
                <div id="textfield"><input type="text" name="q" /></div>
                <div id="searchbutton"><input type="submit" value="Search" /></div>
                <input type="hidden" name="check_keywords" value="yes" />
                <input type="hidden" name="area" value="default" />
            </form>
        </div>
        <script type="text/javascript">$('#searchbox').show(0);</script> 
    <div class="clearer"></div>
</div>

<div class="wrapper">
   
    <div class="navBox" > 
            <div id="searchbox-navbar"  role="search">
                    <form class="search" action="../search.html" method="get">
                        <div id="textfield"><input type="text" name="q" /></div>
                        <div id="searchbutton"><input type="submit" value="Search" /></div>
                        <input type="hidden" name="check_keywords" value="yes" />
                        <input type="hidden" name="area" value="default" />
                    </form>
                </div>
                <script type="text/javascript">$('#searchbox').show(0);</script> 
                <div class="clearer"></div>
            <div id="toc">
                <h1>Contents</h1>  
                <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../beginner/ql-tutorials.html">QL tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../writing-queries/writing-queries.html">CodeQL queries</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cpp/ql-for-cpp.html">CodeQL for C and C++</a></li>
<li class="toctree-l1"><a class="reference internal" href="../csharp/ql-for-csharp.html">CodeQL for C#</a></li>
<li class="toctree-l1"><a class="reference internal" href="../go/ql-for-go.html">CodeQL for Go</a></li>
<li class="toctree-l1"><a class="reference internal" href="../java/ql-for-java.html">CodeQL for Java</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="ql-for-javascript.html">CodeQL for JavaScript</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="basic-query-javascript.html">Basic query for JavaScript code</a></li>
<li class="toctree-l2"><a class="reference internal" href="introduce-libraries-js.html">CodeQL library for JavaScript</a></li>
<li class="toctree-l2"><a class="reference internal" href="introduce-libraries-ts.html">CodeQL library for TypeScript</a></li>
<li class="toctree-l2"><a class="reference internal" href="dataflow.html">Analyzing data flow in JavaScript and TypeScript</a></li>
<li class="toctree-l2"><a class="reference internal" href="flow-labels.html">Using flow labels for precise data flow analysis</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Using type tracking for API modeling</a></li>
<li class="toctree-l2"><a class="reference internal" href="ast-class-reference.html">Abstract syntax tree classes for working with JavaScript and TypeScript programs</a></li>
<li class="toctree-l2"><a class="reference internal" href="dataflow-cheat-sheet.html">Data flow cheat sheet for JavaScript</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../python/ql-for-python.html">CodeQL for Python</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ql-training.html">CodeQL training and variant analysis examples</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../terminology-note.html">Recent terminology changes</a></li>
</ul>

            </div>
    </div>
    <div class="mainBox">
        
  

    <div class="document">
      <div class="documentwrapper">
          <div class="body" role="main">
            
  <div class="section" id="using-type-tracking-for-api-modeling">
<h1>Using type tracking for API modeling<a class="headerlink" href="#using-type-tracking-for-api-modeling" title="Permalink to this headline">¶</a></h1>
<p>You can track data through an API by creating a model using the CodeQL type-tracking library for JavaScript.</p>
<div class="section" id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Permalink to this headline">¶</a></h2>
<p>The type-tracking library makes it possible to track values through properties and function calls,
usually to recognize method calls and properties accessed on a specific type of object.</p>
<p>This is an advanced topic and is intended for readers already familiar with the
<a class="reference external" href="https://help.semmle.com/QL/learn-ql/javascript/dataflow.html#source-nodes">SourceNode</a> class as well as
<a class="reference external" href="https://help.semmle.com/QL/learn-ql/javascript/dataflow.html#using-global-taint-tracking">taint tracking</a>.
For TypeScript analysis also consider reading about <a class="reference external" href="https://help.semmle.com/QL/learn-ql/javascript/introduce-libraries-ts.html#static-type-information">static type information</a> first.</p>
</div>
<div class="section" id="the-problem-of-recognizing-method-calls">
<h2>The problem of recognizing method calls<a class="headerlink" href="#the-problem-of-recognizing-method-calls" title="Permalink to this headline">¶</a></h2>
<p>We’ll start with a simple model of the <a class="reference external" href="https://firebase.google.com/docs/reference/js/firebase.database">Firebase API</a> and gradually build on it to use type tracking.
Knowledge of Firebase is not required.</p>
<p>Suppose we wish to find places where data is written to a Firebase database, as
in the following example:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span></span><span class="kd">var</span> <span class="nx">ref</span> <span class="o">=</span> <span class="nx">firebase</span><span class="p">.</span><span class="nx">database</span><span class="p">().</span><span class="nx">ref</span><span class="p">(</span><span class="s2">&quot;forecast&quot;</span><span class="p">);</span>
<span class="nx">ref</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s2">&quot;Rain&quot;</span><span class="p">);</span> <span class="c1">// &lt;-- find this call</span>
</pre></div>
</div>
<p>A simple way to do this is just to find
all method calls named “<code class="docutils literal"><span class="pre">set</span></code>”:</p>
<div class="highlight-ql"><div class="highlight"><pre><span></span><span class="k">import</span> <span class="n">javascript</span>
<span class="k">import</span> <span class="n">DataFlow</span>

<span class="n">MethodCallNode</span> <span class="n">firebaseSetterCall</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">result</span><span class="p">.</span><span class="n">getMethodName</span><span class="p">()</span> <span class="o">=</span> <span class="s">&quot;set&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The obvious problem with this is that it finds calls to <em>all</em> methods named <code class="docutils literal"><span class="pre">set</span></code>,
many of which are unrelated to Firebase.</p>
<p>Another approach is to use local data flow to match the chain of calls that led to this call:</p>
<div class="highlight-ql"><div class="highlight"><pre><span></span><span class="n">MethodCallNode</span> <span class="n">firebaseSetterCall</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">result</span> <span class="o">=</span> <span class="n">globalVarRef</span><span class="p">(</span><span class="s">&quot;firebase&quot;</span><span class="p">)</span>
      <span class="p">.</span><span class="n">getAMethodCall</span><span class="p">(</span><span class="s">&quot;database&quot;</span><span class="p">)</span>
      <span class="p">.</span><span class="n">getAMethodCall</span><span class="p">(</span><span class="s">&quot;ref&quot;</span><span class="p">)</span>
      <span class="p">.</span><span class="n">getAMethodCall</span><span class="p">(</span><span class="s">&quot;set&quot;</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
</div>
<p>This will find the <code class="docutils literal"><span class="pre">set</span></code> call from the example, but no spurious, unrelated <code class="docutils literal"><span class="pre">set</span></code> method calls.
We can split it up so each step is its own predicate:</p>
<div class="highlight-ql"><div class="highlight"><pre><span></span><span class="n">SourceNode</span> <span class="n">firebase</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">result</span> <span class="o">=</span> <span class="n">globalVarRef</span><span class="p">(</span><span class="s">&quot;firebase&quot;</span><span class="p">)</span>
<span class="p">}</span>

<span class="n">SourceNode</span> <span class="n">firebaseDatabase</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">result</span> <span class="o">=</span> <span class="n">firebase</span><span class="p">().</span><span class="n">getAMethodCall</span><span class="p">(</span><span class="s">&quot;database&quot;</span><span class="p">)</span>
<span class="p">}</span>

<span class="n">SourceNode</span> <span class="n">firebaseRef</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">result</span> <span class="o">=</span> <span class="n">firebaseDatabase</span><span class="p">().</span><span class="n">getAMethodCall</span><span class="p">(</span><span class="s">&quot;ref&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">MethodCallNode</span> <span class="n">firebaseSetterCall</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">result</span> <span class="o">=</span> <span class="n">firebaseRef</span><span class="p">().</span><span class="n">getAMethodCall</span><span class="p">(</span><span class="s">&quot;set&quot;</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The code above is equivalent to the previous version,
but it’s easier to tinker with the individual steps.</p>
<p>The downside is that the model relies entirely on local data flow,
which means it won’t look through properties and function calls.
For instance, <code class="docutils literal"><span class="pre">firebaseSetterCall()</span></code> fails to find anything in this example:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span></span><span class="kd">function</span> <span class="nx">getDatabase</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">firebase</span><span class="p">.</span><span class="nx">database</span><span class="p">();</span>
<span class="p">}</span>
<span class="kd">var</span> <span class="nx">ref</span> <span class="o">=</span> <span class="nx">getDatabase</span><span class="p">().</span><span class="nx">ref</span><span class="p">(</span><span class="s2">&quot;forecast&quot;</span><span class="p">);</span>
<span class="nx">ref</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s2">&quot;Rain&quot;</span><span class="p">);</span>
</pre></div>
</div>
<p>Notice that the predicate <code class="docutils literal"><span class="pre">firebaseDatabase()</span></code> still finds the call to <code class="docutils literal"><span class="pre">firebase.database()</span></code>,
but not the <code class="docutils literal"><span class="pre">getDatabase()</span></code> call.
This means <code class="docutils literal"><span class="pre">firebaseRef()</span></code> has no result, which in turn means <code class="docutils literal"><span class="pre">firebaseSetterCall()</span></code> has no result.</p>
<p>As a simple remedy, let’s try to make <code class="docutils literal"><span class="pre">firebaseDatabase()</span></code> recognize the <code class="docutils literal"><span class="pre">getDatabase()</span></code> call:</p>
<div class="highlight-ql"><div class="highlight"><pre><span></span><span class="n">SourceNode</span> <span class="n">firebaseDatabase</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">result</span> <span class="o">=</span> <span class="n">firebase</span><span class="p">().</span><span class="n">getAMethodCall</span><span class="p">(</span><span class="s">&quot;database&quot;</span><span class="p">)</span>
  <span class="k">or</span>
  <span class="k">result</span><span class="p">.(</span><span class="n">CallNode</span><span class="p">).</span><span class="n">getACallee</span><span class="p">().</span><span class="n">getAReturn</span><span class="p">().</span><span class="n">getALocalSource</span><span class="p">()</span> <span class="o">=</span> <span class="n">firebaseDatabase</span><span class="p">()</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The second clause ensures <code class="docutils literal"><span class="pre">firebaseDatabase()</span></code> finds not only <code class="docutils literal"><span class="pre">firebase.database()</span></code> calls,
but also calls to functions that <em>return</em> <code class="docutils literal"><span class="pre">firebase.database()</span></code>, such as <code class="docutils literal"><span class="pre">getDatabase()</span></code> seen above.
It’s recursive, so it handles flow out of any number of nested function calls.</p>
<p>However, it still only tracks <em>out</em> of functions, not <em>into</em> functions through parameters, nor through properties.
Instead of adding these steps by hand, we’ll use type tracking.</p>
</div>
<div class="section" id="type-tracking-in-general">
<h2>Type tracking in general<a class="headerlink" href="#type-tracking-in-general" title="Permalink to this headline">¶</a></h2>
<p>Type tracking is a generalization of the above pattern, where a predicate matches the value to track,
and has a recursive clause that tracks the flow of that value.
But instead of us having to deal with function calls/returns and property reads/writes,
all of these steps are included in a single predicate,
<a class="reference external" href="https://help.semmle.com/qldoc/javascript/semmle/javascript/dataflow/Sources.qll/predicate.Sources$SourceNode$track.2.html">SourceNode.track</a>,
to be used with the companion class
<a class="reference external" href="https://help.semmle.com/qldoc/javascript/semmle/javascript/dataflow/TypeTracking.qll/type.TypeTracking$TypeTracker.html">TypeTracker</a>.</p>
<p>Predicates that use type tracking usually conform to the following general pattern, which we explain below:</p>
<div class="highlight-ql"><div class="highlight"><pre><span></span><span class="n">SourceNode</span> <span class="n">myType</span><span class="p">(</span><span class="n">TypeTracker</span> <span class="n">t</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">t</span><span class="p">.</span><span class="n">start</span><span class="p">()</span> <span class="k">and</span>
  <span class="k">result</span> <span class="o">=</span> <span class="cm">/* SourceNode to track */</span>
  <span class="k">or</span>
  <span class="k">exists</span><span class="p">(</span><span class="n">TypeTracker</span> <span class="n">t</span><span class="m">2</span> <span class="o">|</span>
    <span class="k">result</span> <span class="o">=</span> <span class="n">myType</span><span class="p">(</span><span class="n">t</span><span class="m">2</span><span class="p">).</span><span class="n">track</span><span class="p">(</span><span class="n">t</span><span class="m">2</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>
  <span class="p">)</span>
<span class="p">}</span>

<span class="n">SourceNode</span> <span class="n">myType</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">result</span> <span class="o">=</span> <span class="n">myType</span><span class="p">(</span><span class="n">TypeTracker</span><span class="o">::</span><span class="n">end</span><span class="p">())</span>
<span class="p">}</span>
</pre></div>
</div>
<p>We’ll apply the pattern to our example model and use that to explain what’s going on.</p>
</div>
<div class="section" id="tracking-the-database-instance">
<h2>Tracking the database instance<a class="headerlink" href="#tracking-the-database-instance" title="Permalink to this headline">¶</a></h2>
<p>Applying the above pattern to the <code class="docutils literal"><span class="pre">firebaseDatabase()</span></code> predicate we get the following:</p>
<div class="highlight-ql"><div class="highlight"><pre><span></span><span class="n">SourceNode</span> <span class="n">firebaseDatabase</span><span class="p">(</span><span class="n">TypeTracker</span> <span class="n">t</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">t</span><span class="p">.</span><span class="n">start</span><span class="p">()</span> <span class="k">and</span>
  <span class="k">result</span> <span class="o">=</span> <span class="n">firebase</span><span class="p">().</span><span class="n">getAMethodCall</span><span class="p">(</span><span class="s">&quot;database&quot;</span><span class="p">)</span>
  <span class="k">or</span>
  <span class="k">exists</span><span class="p">(</span><span class="n">TypeTracker</span> <span class="n">t</span><span class="m">2</span> <span class="o">|</span>
    <span class="k">result</span> <span class="o">=</span> <span class="n">firebaseDatabase</span><span class="p">(</span><span class="n">t</span><span class="m">2</span><span class="p">).</span><span class="n">track</span><span class="p">(</span><span class="n">t</span><span class="m">2</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>
  <span class="p">)</span>
<span class="p">}</span>

<span class="n">SourceNode</span> <span class="n">firebaseDatabase</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">result</span> <span class="o">=</span> <span class="n">firebaseDatabase</span><span class="p">(</span><span class="n">TypeTracker</span><span class="o">::</span><span class="n">end</span><span class="p">())</span>
<span class="p">}</span>
</pre></div>
</div>
<p>There are now two predicates named <code class="docutils literal"><span class="pre">firebaseDatabase</span></code>.
The one with the <code class="docutils literal"><span class="pre">TypeTracker</span></code> parameter is the one actually doing the global data flow tracking
– the other predicate exposes the result in a convenient way.</p>
<p>The new <code class="docutils literal"><span class="pre">TypeTracker</span> <span class="pre">t</span></code> parameter is a summary of the steps needed to track the value of interest to the resulting data flow node.</p>
<p>In the base case, when matching <code class="docutils literal"><span class="pre">firebase.database()</span></code>, we use <code class="docutils literal"><span class="pre">t.start()</span></code> to indicate that no steps were needed, that is,
this is the starting point of type tracking:</p>
<div class="highlight-ql"><div class="highlight"><pre><span></span><span class="n">t</span><span class="p">.</span><span class="n">start</span><span class="p">()</span> <span class="k">and</span>
<span class="k">result</span> <span class="o">=</span> <span class="n">firebase</span><span class="p">().</span><span class="n">getAMethodCall</span><span class="p">(</span><span class="s">&quot;database&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>In the recursive case, we apply the <code class="docutils literal"><span class="pre">track</span></code> predicate on a previously-found Firebase database node, such as <code class="docutils literal"><span class="pre">firebase.database()</span></code>.
The <code class="docutils literal"><span class="pre">track</span></code> predicate maps this to a successor of that node, such as <code class="docutils literal"><span class="pre">getDatabase()</span></code>, and
binds <code class="docutils literal"><span class="pre">t</span></code> to the continuation of <code class="docutils literal"><span class="pre">t2</span></code> with this extra step included:</p>
<div class="highlight-ql"><div class="highlight"><pre><span></span><span class="k">exists</span><span class="p">(</span><span class="n">TypeTracker</span> <span class="n">t</span><span class="m">2</span> <span class="o">|</span>
  <span class="k">result</span> <span class="o">=</span> <span class="n">firebaseDatabase</span><span class="p">(</span><span class="n">t</span><span class="m">2</span><span class="p">).</span><span class="n">track</span><span class="p">(</span><span class="n">t</span><span class="m">2</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
<p>To understand the role of <code class="docutils literal"><span class="pre">t</span></code> here, note that type tracking can step <em>into</em> a property, which means
the data flow node returned from <code class="docutils literal"><span class="pre">track</span></code> is not necessarily a Firebase database instance, it could be
an object <em>containing</em> a Firebase database in one of its properties.</p>
<p>For example, in the program below, the <code class="docutils literal"><span class="pre">firebaseDatabase(t)</span></code> predicate includes the <code class="docutils literal"><span class="pre">obj</span></code> node in its result,
but with <code class="docutils literal"><span class="pre">t</span></code> recording the fact that the actual value being tracked is inside the <code class="docutils literal"><span class="pre">DB</span></code> property:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span></span><span class="kd">let</span> <span class="nx">obj</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">DB</span><span class="o">:</span> <span class="nx">firebase</span><span class="p">.</span><span class="nx">database</span><span class="p">()</span> <span class="p">};</span>
<span class="kd">let</span> <span class="nx">db</span> <span class="o">=</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">DB</span><span class="p">;</span>
</pre></div>
</div>
<p>This brings us to the last predicate. This uses <code class="docutils literal"><span class="pre">TypeTracker::end()</span></code> to filter out
the paths where the Firebase database instance ended up inside a property of another object,
so it includes <code class="docutils literal"><span class="pre">db</span></code> but not <code class="docutils literal"><span class="pre">obj</span></code>:</p>
<div class="highlight-ql"><div class="highlight"><pre><span></span><span class="n">SourceNode</span> <span class="n">firebaseDatabase</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">result</span> <span class="o">=</span> <span class="n">firebaseDatabase</span><span class="p">(</span><span class="n">TypeTracker</span><span class="o">::</span><span class="n">end</span><span class="p">())</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Here’s see an example of what this can handle now:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span></span><span class="kr">class</span> <span class="nx">Firebase</span> <span class="p">{</span>
  <span class="nx">constructor</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">db</span> <span class="o">=</span> <span class="nx">firebase</span><span class="p">.</span><span class="nx">database</span><span class="p">();</span>
  <span class="p">}</span>

  <span class="nx">getDatabase</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">db</span><span class="p">;</span> <span class="p">}</span>

  <span class="nx">setForecast</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">getDatabase</span><span class="p">().</span><span class="nx">ref</span><span class="p">(</span><span class="s2">&quot;forecast&quot;</span><span class="p">).</span><span class="nx">set</span><span class="p">(</span><span class="nx">value</span><span class="p">);</span> <span class="c1">// found by firebaseSetterCall()</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="tracking-in-the-whole-model">
<h2>Tracking in the whole model<a class="headerlink" href="#tracking-in-the-whole-model" title="Permalink to this headline">¶</a></h2>
<p>We applied this pattern to <code class="docutils literal"><span class="pre">firebaseDatabase()</span></code> in the previous section, and it
can just as easily apply to the other predicates.
For reference, here’s our simple Firebase model with type tracking on every predicate:</p>
<div class="highlight-ql"><div class="highlight"><pre><span></span><span class="n">SourceNode</span> <span class="n">firebase</span><span class="p">(</span><span class="n">TypeTracker</span> <span class="n">t</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">t</span><span class="p">.</span><span class="n">start</span><span class="p">()</span> <span class="k">and</span>
  <span class="k">result</span> <span class="o">=</span> <span class="n">globalVarRef</span><span class="p">(</span><span class="s">&quot;firebase&quot;</span><span class="p">)</span>
  <span class="k">or</span>
  <span class="k">exists</span><span class="p">(</span><span class="n">TypeTracker</span> <span class="n">t</span><span class="m">2</span> <span class="o">|</span>
    <span class="k">result</span> <span class="o">=</span> <span class="n">firebase</span><span class="p">(</span><span class="n">t</span><span class="m">2</span><span class="p">).</span><span class="n">track</span><span class="p">(</span><span class="n">t</span><span class="m">2</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>
  <span class="p">)</span>
<span class="p">}</span>

<span class="n">SourceNode</span> <span class="n">firebase</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">result</span> <span class="o">=</span> <span class="n">firebase</span><span class="p">(</span><span class="n">TypeTracker</span><span class="o">::</span><span class="n">end</span><span class="p">())</span>
<span class="p">}</span>

<span class="n">SourceNode</span> <span class="n">firebaseDatabase</span><span class="p">(</span><span class="n">TypeTracker</span> <span class="n">t</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">t</span><span class="p">.</span><span class="n">start</span><span class="p">()</span> <span class="k">and</span>
  <span class="k">result</span> <span class="o">=</span> <span class="n">firebase</span><span class="p">().</span><span class="n">getAMethodCall</span><span class="p">(</span><span class="s">&quot;database&quot;</span><span class="p">)</span>
  <span class="k">or</span>
  <span class="k">exists</span><span class="p">(</span><span class="n">TypeTracker</span> <span class="n">t</span><span class="m">2</span> <span class="o">|</span>
    <span class="k">result</span> <span class="o">=</span> <span class="n">firebaseDatabase</span><span class="p">(</span><span class="n">t</span><span class="m">2</span><span class="p">).</span><span class="n">track</span><span class="p">(</span><span class="n">t</span><span class="m">2</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>
  <span class="p">)</span>
<span class="p">}</span>

<span class="n">SourceNode</span> <span class="n">firebaseDatabase</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">result</span> <span class="o">=</span> <span class="n">firebaseDatabase</span><span class="p">(</span><span class="n">TypeTracker</span><span class="o">::</span><span class="n">end</span><span class="p">())</span>
<span class="p">}</span>

<span class="n">SourceNode</span> <span class="n">firebaseRef</span><span class="p">(</span><span class="n">TypeTracker</span> <span class="n">t</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">t</span><span class="p">.</span><span class="n">start</span><span class="p">()</span> <span class="k">and</span>
  <span class="k">result</span> <span class="o">=</span> <span class="n">firebaseDatabase</span><span class="p">().</span><span class="n">getAMethodCall</span><span class="p">(</span><span class="s">&quot;ref&quot;</span><span class="p">)</span>
  <span class="k">or</span>
  <span class="k">exists</span><span class="p">(</span><span class="n">TypeTracker</span> <span class="n">t</span><span class="m">2</span> <span class="o">|</span>
    <span class="k">result</span> <span class="o">=</span> <span class="n">firebaseRef</span><span class="p">(</span><span class="n">t</span><span class="m">2</span><span class="p">).</span><span class="n">track</span><span class="p">(</span><span class="n">t</span><span class="m">2</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>
  <span class="p">)</span>
<span class="p">}</span>

<span class="n">SourceNode</span> <span class="n">firebaseRef</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">result</span> <span class="o">=</span> <span class="n">firebaseRef</span><span class="p">(</span><span class="n">TypeTracker</span><span class="o">::</span><span class="n">end</span><span class="p">())</span>
<span class="p">}</span>

<span class="n">MethodCallNode</span> <span class="n">firebaseSetterCall</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">result</span> <span class="o">=</span> <span class="n">firebaseRef</span><span class="p">().</span><span class="n">getAMethodCall</span><span class="p">(</span><span class="s">&quot;set&quot;</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
</div>
<p><a class="reference external" href="https://lgtm.com/query/1053770500827789481">Here</a> is a run of an example query using the model to find <cite>set</cite> calls on one of the Firebase sample projects.
It’s been modified slightly to handle a bit more of the API, which is beyond the scope of this tutorial.</p>
</div>
<div class="section" id="tracking-associated-data">
<h2>Tracking associated data<a class="headerlink" href="#tracking-associated-data" title="Permalink to this headline">¶</a></h2>
<p>By adding extra parameters to the type-tracking predicate, we can carry along
extra bits of information about the result.</p>
<p>For example, here’s a type-tracking version of <code class="docutils literal"><span class="pre">firebaseRef()</span></code>, which
tracks the string that was passed to the <code class="docutils literal"><span class="pre">ref</span></code> call:</p>
<div class="highlight-ql"><div class="highlight"><pre><span></span><span class="n">SourceNode</span> <span class="n">firebaseRef</span><span class="p">(</span><span class="kt">string</span> <span class="n">name</span><span class="p">,</span> <span class="n">TypeTracker</span> <span class="n">t</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">t</span><span class="p">.</span><span class="n">start</span><span class="p">()</span> <span class="k">and</span>
  <span class="k">exists</span><span class="p">(</span><span class="n">CallNode</span> <span class="n">call</span> <span class="o">|</span>
    <span class="n">call</span> <span class="o">=</span> <span class="n">firebaseDatabase</span><span class="p">().</span><span class="n">getAMethodCall</span><span class="p">(</span><span class="s">&quot;ref&quot;</span><span class="p">)</span> <span class="k">and</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">call</span><span class="p">.</span><span class="n">getArgument</span><span class="p">(</span><span class="m">0</span><span class="p">).</span><span class="n">getStringValue</span><span class="p">()</span> <span class="k">and</span>
    <span class="k">result</span> <span class="o">=</span> <span class="n">call</span>
  <span class="p">)</span>
  <span class="k">or</span>
  <span class="k">exists</span><span class="p">(</span><span class="n">TypeTracker</span> <span class="n">t</span><span class="m">2</span> <span class="o">|</span>
    <span class="k">result</span> <span class="o">=</span> <span class="n">firebaseRef</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">t</span><span class="m">2</span><span class="p">).</span><span class="n">track</span><span class="p">(</span><span class="n">t</span><span class="m">2</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>
  <span class="p">)</span>
<span class="p">}</span>

<span class="n">SourceNode</span> <span class="n">firebaseRef</span><span class="p">(</span><span class="kt">string</span> <span class="n">name</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">result</span> <span class="o">=</span> <span class="n">firebaseRef</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">TypeTracker</span><span class="o">::</span><span class="n">end</span><span class="p">())</span>
<span class="p">}</span>

<span class="n">MethodCallNode</span> <span class="n">firebaseSetterCall</span><span class="p">(</span><span class="kt">string</span> <span class="n">refName</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">result</span> <span class="o">=</span> <span class="n">firebaseRef</span><span class="p">(</span><span class="n">refName</span><span class="p">).</span><span class="n">getAMethodCall</span><span class="p">(</span><span class="s">&quot;set&quot;</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
</div>
<p>So now we can use <code class="docutils literal"><span class="pre">firebaseSetterCall(&quot;forecast&quot;)</span></code> to find assignments to the forecast.</p>
</div>
<div class="section" id="back-tracking-callbacks">
<h2>Back-tracking callbacks<a class="headerlink" href="#back-tracking-callbacks" title="Permalink to this headline">¶</a></h2>
<p>The type-tracking predicates we’ve seen above all use <em>forward</em> tracking.
That is, they all start with some value of interest and ask “where does this flow?”.</p>
<p>Sometimes it’s more useful to work backwards, starting at the desired end-point and asking “what flows to here?”.</p>
<p>As a motivating example, we’ll extend our model to look for places where we <em>read</em> a value
from the database, as opposed to writing it.
Reading is an asynchronous operation and the result is obtained through a callback, for example:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span></span><span class="kd">function</span> <span class="nx">fetchForecast</span><span class="p">(</span><span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">firebase</span><span class="p">.</span><span class="nx">database</span><span class="p">().</span><span class="nx">ref</span><span class="p">(</span><span class="s2">&quot;forecast&quot;</span><span class="p">).</span><span class="nx">once</span><span class="p">(</span><span class="s2">&quot;value&quot;</span><span class="p">,</span> <span class="nx">callback</span><span class="p">);</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">updateReminders</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">fetchForecast</span><span class="p">((</span><span class="nx">snapshot</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nx">forecast</span> <span class="o">=</span> <span class="nx">snapshot</span><span class="p">.</span><span class="nx">val</span><span class="p">();</span> <span class="c1">// &lt;-- find this call</span>
    <span class="nx">addReminder</span><span class="p">(</span><span class="nx">forecast</span> <span class="o">===</span> <span class="s2">&quot;Rain&quot;</span> <span class="o">?</span> <span class="s2">&quot;Umbrella&quot;</span> <span class="o">:</span> <span class="s2">&quot;Sunscreen&quot;</span><span class="p">);</span>
  <span class="p">})</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The actual forecast is obtained by the call to <code class="docutils literal"><span class="pre">snapshot.val()</span></code>.</p>
<p>Looking for all method calls named <code class="docutils literal"><span class="pre">val</span></code> will in practice find many unrelated methods,
so we’ll use type tracking again to take the receiver type into account.</p>
<p>The receiver <code class="docutils literal"><span class="pre">snapshot</span></code> is a parameter to a callback function, which ultimately escapes
into the <code class="docutils literal"><span class="pre">once()</span></code> call. We’ll extend our model from above to use back-tracking to find
all functions that flow into the <code class="docutils literal"><span class="pre">once()</span></code> call.
Backwards type tracking is not too different from forwards type tracking. The differences are:</p>
<ul class="simple">
<li>The <code class="docutils literal"><span class="pre">TypeTracker</span></code> parameter instead has type <code class="docutils literal"><span class="pre">TypeBackTracker</span></code>.</li>
<li>The call to <code class="docutils literal"><span class="pre">.track()</span></code> is instead a call to <code class="docutils literal"><span class="pre">.backtrack()</span></code>.</li>
<li>To ensure the initial value is a source node, a call to <code class="docutils literal"><span class="pre">getALocalSource()</span></code> is usually required.</li>
</ul>
<div class="highlight-ql"><div class="highlight"><pre><span></span><span class="n">SourceNode</span> <span class="n">firebaseSnapshotCallback</span><span class="p">(</span><span class="kt">string</span> <span class="n">refName</span><span class="p">,</span> <span class="n">TypeBackTracker</span> <span class="n">t</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">t</span><span class="p">.</span><span class="n">start</span><span class="p">()</span> <span class="k">and</span>
  <span class="k">result</span> <span class="o">=</span> <span class="n">firebaseRef</span><span class="p">(</span><span class="n">refName</span><span class="p">).</span><span class="n">getAMethodCall</span><span class="p">(</span><span class="s">&quot;once&quot;</span><span class="p">).</span><span class="n">getArgument</span><span class="p">(</span><span class="m">1</span><span class="p">).</span><span class="n">getALocalSource</span><span class="p">()</span>
  <span class="k">or</span>
  <span class="k">exists</span><span class="p">(</span><span class="n">TypeBackTracker</span> <span class="n">t</span><span class="m">2</span> <span class="o">|</span>
    <span class="k">result</span> <span class="o">=</span> <span class="n">firebaseSnapshotCallback</span><span class="p">(</span><span class="n">refName</span><span class="p">,</span> <span class="n">t</span><span class="m">2</span><span class="p">).</span><span class="n">backtrack</span><span class="p">(</span><span class="n">t</span><span class="m">2</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>
  <span class="p">)</span>
<span class="p">}</span>

<span class="n">FunctionNode</span> <span class="n">firebaseSnapshotCallback</span><span class="p">(</span><span class="kt">string</span> <span class="n">refName</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">result</span> <span class="o">=</span> <span class="n">firebaseSnapshotCallback</span><span class="p">(</span><span class="n">refName</span><span class="p">,</span> <span class="n">TypeBackTracker</span><span class="o">::</span><span class="n">end</span><span class="p">())</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Now, <code class="docutils literal"><span class="pre">firebaseSnapshotCallback(&quot;forecast&quot;)</span></code> finds the function being passed to <code class="docutils literal"><span class="pre">fetchForecast</span></code>.
Based on that we can track the <code class="docutils literal"><span class="pre">snapshot</span></code> value and find the <code class="docutils literal"><span class="pre">val()</span></code> call itself:</p>
<div class="highlight-ql"><div class="highlight"><pre><span></span><span class="n">SourceNode</span> <span class="n">firebaseSnapshot</span><span class="p">(</span><span class="kt">string</span> <span class="n">refName</span><span class="p">,</span> <span class="n">TypeTracker</span> <span class="n">t</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">t</span><span class="p">.</span><span class="n">start</span><span class="p">()</span> <span class="k">and</span>
  <span class="k">result</span> <span class="o">=</span> <span class="n">firebaseSnapshotCallback</span><span class="p">(</span><span class="n">refName</span><span class="p">).</span><span class="n">getParameter</span><span class="p">(</span><span class="m">0</span><span class="p">)</span>
  <span class="k">or</span>
  <span class="k">exists</span><span class="p">(</span><span class="n">TypeTracker</span> <span class="n">t</span><span class="m">2</span> <span class="o">|</span>
    <span class="k">result</span> <span class="o">=</span> <span class="n">firebaseSnapshot</span><span class="p">(</span><span class="n">refName</span><span class="p">,</span> <span class="n">t</span><span class="m">2</span><span class="p">).</span><span class="n">track</span><span class="p">(</span><span class="n">t</span><span class="m">2</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>
  <span class="p">)</span>
<span class="p">}</span>

<span class="n">SourceNode</span> <span class="n">firebaseSnapshot</span><span class="p">(</span><span class="kt">string</span> <span class="n">refName</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">result</span> <span class="o">=</span> <span class="n">firebaseSnapshot</span><span class="p">(</span><span class="n">refName</span><span class="p">,</span> <span class="n">TypeTracker</span><span class="o">::</span><span class="n">end</span><span class="p">())</span>
<span class="p">}</span>

<span class="n">MethodCallNode</span> <span class="n">firebaseDatabaseRead</span><span class="p">(</span><span class="kt">string</span> <span class="n">refName</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">result</span> <span class="o">=</span> <span class="n">firebaseSnapshot</span><span class="p">(</span><span class="n">refName</span><span class="p">).</span><span class="n">getAMethodCall</span><span class="p">(</span><span class="s">&quot;val&quot;</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
</div>
<p>With this addition, <code class="docutils literal"><span class="pre">firebaseDatabaseRead(&quot;forecast&quot;)</span></code> finds the call to <code class="docutils literal"><span class="pre">snapshot.val()</span></code> that contains the value of the forecast.</p>
<p><a class="reference external" href="https://lgtm.com/query/8761360814276109092">Here</a> is a run of an example query using the model to find <cite>val</cite> calls.</p>
</div>
<div class="section" id="summary">
<h2>Summary<a class="headerlink" href="#summary" title="Permalink to this headline">¶</a></h2>
<p>We have covered how to use the type-tracking library. To recap, use this template to define forward type-tracking predicates:</p>
<div class="highlight-ql"><div class="highlight"><pre><span></span><span class="n">SourceNode</span> <span class="n">myType</span><span class="p">(</span><span class="n">TypeTracker</span> <span class="n">t</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">t</span><span class="p">.</span><span class="n">start</span><span class="p">()</span> <span class="k">and</span>
  <span class="k">result</span> <span class="o">=</span> <span class="cm">/* SourceNode to track */</span>
  <span class="k">or</span>
  <span class="k">exists</span><span class="p">(</span><span class="n">TypeTracker</span> <span class="n">t</span><span class="m">2</span> <span class="o">|</span>
    <span class="k">result</span> <span class="o">=</span> <span class="n">myType</span><span class="p">(</span><span class="n">t</span><span class="m">2</span><span class="p">).</span><span class="n">track</span><span class="p">(</span><span class="n">t</span><span class="m">2</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>
  <span class="p">)</span>
<span class="p">}</span>

<span class="n">SourceNode</span> <span class="n">myType</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">result</span> <span class="o">=</span> <span class="n">myType</span><span class="p">(</span><span class="n">TypeTracker</span><span class="o">::</span><span class="n">end</span><span class="p">())</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Use this template to define backward type-tracking predicates:</p>
<div class="highlight-ql"><div class="highlight"><pre><span></span><span class="n">SourceNode</span> <span class="n">myType</span><span class="p">(</span><span class="n">TypeBackTracker</span> <span class="n">t</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">t</span><span class="p">.</span><span class="n">start</span><span class="p">()</span> <span class="k">and</span>
  <span class="k">result</span> <span class="o">=</span> <span class="p">(</span><span class="cm">/* argument to track */</span><span class="p">).</span><span class="n">getALocalSource</span><span class="p">()</span>
  <span class="k">or</span>
  <span class="k">exists</span><span class="p">(</span><span class="n">TypeBackTracker</span> <span class="n">t</span><span class="m">2</span> <span class="o">|</span>
    <span class="k">result</span> <span class="o">=</span> <span class="n">myType</span><span class="p">(</span><span class="n">t</span><span class="m">2</span><span class="p">).</span><span class="n">backtrack</span><span class="p">(</span><span class="n">t</span><span class="m">2</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>
  <span class="p">)</span>
<span class="p">}</span>

<span class="n">SourceNode</span> <span class="n">myType</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">result</span> <span class="o">=</span> <span class="n">myType</span><span class="p">(</span><span class="n">TypeBackTracker</span><span class="o">::</span><span class="n">end</span><span class="p">())</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Note that these predicates all return <code class="docutils literal"><span class="pre">SourceNode</span></code>,
so attempts to track a non-source node, such as an identifier or string literal,
will not work.
If this becomes an issue, see
<a class="reference external" href="https://help.semmle.com/qldoc/javascript/semmle/javascript/dataflow/TypeTracking.qll/predicate.TypeTracking$TypeTracker$smallstep.2.html">TypeTracker.smallstep</a>.</p>
<p>Also note that the predicates taking a <code class="docutils literal"><span class="pre">TypeTracker</span></code> or <code class="docutils literal"><span class="pre">TypeBackTracker</span></code> can often be made <code class="docutils literal"><span class="pre">private</span></code>,
as they are typically only used as an intermediate result to compute the other predicate.</p>
</div>
<div class="section" id="limitations">
<h2>Limitations<a class="headerlink" href="#limitations" title="Permalink to this headline">¶</a></h2>
<p>As mentioned, type tracking will track values in and out of function calls and properties,
but only within some limits.</p>
<p>For example, type tracking does not always track <em>through</em> functions. That is, if a value flows into a parameter
and back out of the return value, it might not be tracked back out to the call site again.
Here’s an example that the model from this tutorial won’t find:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span></span><span class="kd">function</span> <span class="nx">wrapDB</span><span class="p">(</span><span class="nx">database</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="p">{</span> <span class="nx">db</span><span class="o">:</span> <span class="nx">database</span> <span class="p">}</span>
<span class="p">}</span>
<span class="kd">let</span> <span class="nx">wrapper</span> <span class="o">=</span> <span class="nx">wrapDB</span><span class="p">(</span><span class="nx">firebase</span><span class="p">.</span><span class="nx">database</span><span class="p">())</span>
<span class="nx">wrapper</span><span class="p">.</span><span class="nx">db</span><span class="p">.</span><span class="nx">ref</span><span class="p">(</span><span class="s2">&quot;forecast&quot;</span><span class="p">);</span> <span class="c1">// &lt;-- not found</span>
</pre></div>
</div>
<p>This is an example of where <a class="reference external" href="https://help.semmle.com/QL/learn-ql/javascript/dataflow.html#global-data-flow">data-flow configurations</a> are more powerful.</p>
</div>
<div class="section" id="when-to-use-type-tracking">
<h2>When to use type tracking<a class="headerlink" href="#when-to-use-type-tracking" title="Permalink to this headline">¶</a></h2>
<p>Type tracking and data-flow configurations are different solutions to the same
problem, each with their own tradeoffs.</p>
<p>Type tracking can be used in any number of predicates, which may depend on each other
in fairly unrestricted ways. The result of one predicate may be the starting
point for another. Type-tracking predicates may be mutually recursive.
Type-tracking predicates can have any number of extra parameters, making it possible, but optional,
to construct source/sink pairs. Omitting source/sink pairs can be useful when there is a huge number
of sources and sinks.</p>
<p>Data-flow configurations have more restricted dependencies but are more powerful in other ways.
For performance reasons,
the sources, sinks, and steps of a configuration should not depend on whether a flow path has been found using
that configuration or any other configuration.
In that sense, the sources, sinks, and steps must be configured “up front” and can’t be discovered on-the-fly.
The upside is that they track flow through functions and callbacks in some ways that type tracking doesn’t,
which is particularly important for security queries.
Also, path queries can only be defined using data-flow configurations.</p>
<p>Prefer type tracking when:</p>
<ul class="simple">
<li>Disambiguating generically named methods or properties.</li>
<li>Making reusable library components to be shared between queries.</li>
<li>The set of source/sink pairs is too large to compute or has insufficient information.</li>
<li>The information is needed as input to a data-flow configuration.</li>
</ul>
<p>Prefer data-flow configurations when:</p>
<ul class="simple">
<li>Tracking user-controlled data – use <a class="reference external" href="https://help.semmle.com/QL/learn-ql/javascript/dataflow.html#using-global-taint-tracking">taint tracking</a>.</li>
<li>Differentiating between different kinds of user-controlled data – see “<a class="reference internal" href="flow-labels.html"><span class="doc">Using flow labels for precise data flow analysis</span></a>.”</li>
<li>Tracking transformations of a value through generic utility functions.</li>
<li>Tracking values through string manipulation.</li>
<li>Generating a path from source to sink – see “<a class="reference internal" href="../writing-queries/path-queries.html"><span class="doc">Creating path queries</span></a>.”</li>
</ul>
<p>Lastly, depending on the code base being analyzed, some alternatives to consider are:</p>
<ul class="simple">
<li>Using <a class="reference external" href="https://help.semmle.com/QL/learn-ql/javascript/introduce-libraries-ts.html#static-type-information">static type information</a>,
if analyzing TypeScript code.</li>
<li>Relying on local data flow.</li>
<li>Relying on syntactic heuristics such as the name of a method, property, or variable.</li>
</ul>
</div>
<div class="section" id="type-tracking-in-the-standard-libraries">
<h2>Type tracking in the standard libraries<a class="headerlink" href="#type-tracking-in-the-standard-libraries" title="Permalink to this headline">¶</a></h2>
<p>Type tracking is used in a few places in the standard libraries:</p>
<ul class="simple">
<li>The <a class="reference external" href="https://help.semmle.com/qldoc/javascript/semmle/javascript/DOM.qll/module.DOM$DOM.html">DOM</a> predicates,
<a class="reference external" href="https://help.semmle.com/qldoc/javascript/semmle/javascript/DOM.qll/predicate.DOM$DOM$documentRef.0.html">documentRef</a>,
<a class="reference external" href="https://help.semmle.com/qldoc/javascript/semmle/javascript/DOM.qll/predicate.DOM$DOM$locationRef.0.html">locationRef</a>, and
<a class="reference external" href="https://help.semmle.com/qldoc/javascript/semmle/javascript/DOM.qll/predicate.DOM$DOM$domValueRef.0.html">domValueRef</a>,
are implemented with type tracking.</li>
<li>The <a class="reference external" href="https://help.semmle.com/qldoc/javascript/semmle/javascript/frameworks/HTTP.qll/module.HTTP$HTTP.html">HTTP</a> server models, such as <a class="reference external" href="https://help.semmle.com/qldoc/javascript/semmle/javascript/frameworks/Express.qll/module.Express$Express.html">Express</a>, use type tracking to track the installation of router handler functions.</li>
<li>The <a class="reference external" href="https://help.semmle.com/qldoc/javascript/semmle/javascript/frameworks/Firebase.qll/module.Firebase$Firebase.html">Firebase</a> and
<a class="reference external" href="https://help.semmle.com/qldoc/javascript/semmle/javascript/frameworks/SocketIO.qll/module.SocketIO$SocketIO.html">Socket.io</a> models use type tracking to track objects coming from their respective APIs.</li>
</ul>
</div>
<div class="section" id="further-reading">
<h2>Further reading<a class="headerlink" href="#further-reading" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><a class="reference external" href="https://github.com/github/codeql/tree/main/javascript/ql/src">CodeQL queries for JavaScript</a></li>
<li><a class="reference external" href="https://github.com/github/codeql/tree/main/javascript/ql/examples">Example queries for JavaScript</a></li>
<li><a class="reference external" href="https://help.semmle.com/qldoc/javascript/">CodeQL library reference for JavaScript</a></li>
</ul>
<ul class="simple">
<li>“<a class="reference external" href="https://help.semmle.com/QL/ql-handbook">QL language reference</a>”</li>
<li>“<a class="reference external" href="https://help.semmle.com/codeql/codeql-tools.html">CodeQL tools</a>”</li>
</ul>
</div>
</div>


          </div>
      </div>
      <div class="clearer"></div>
    </div>
    </div>
    <div class="privacy">
            <a target="_blank" href="https://help.semmle.com/privacy-policy.html" alt="Privacy policy and tracking preferences" title="Privacy policy and tracking preferences">Privacy policy</a>
    </div>
    
</div>


 <script type="text/javascript">
    $(document).ready(function() {
        $(".toggle > *").hide();
        $(".toggle .name").show();
        $(".toggle .name").click(function() {
            $(this).parent().children().not(".name").toggle(400);
            $(this).parent().children(".name").toggleClass("open");
        })
    });
</script>

  </body>
</html>